{% extends 'p_content.html' %}

{% block p_content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/md-editor/latest/mdEditor.min.css">
<script src="https://cdn.jsdelivr.net/md-editor/latest/mdEditor.min.js"></script>
<div id="container" class="">
    <div id="message_box" class="bg-[#BDCAD6] rounded-lg p-10 m-10 mx-20 flex flex-col justify-between ">
        <!-- Chat container with flexible height and scrollable content -->
        <div id="chat" class="min-h-[32px] flex-grow overflow-y-auto p-5 h-96">
            <!-- Chat messages will be added here -->
             <p id="assistant_message" class="rounded-2xl bg-white p-2 mb-2 max-w-2xl">Hey! I'm MedGPT, your medical assistant today. I'll be asking you some questions about your symptoms so your doctor can give you some medical suggestions! Please send a message to get started.</p>
        </div>
        
        <!-- Message input box always at the bottom -->
        <div id="message_bar" class="w-full flex justify-center items-center mt-4">
            <input type="text" id="message"
            class="p-2 pl-3 w-2/3 rounded-2xl bg-[#ffffff] border border-[#868E96]" placeholder="Type your message here...">
            <button id="send" class="hidden">Send</button>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
    const socket = io();

    const messageInput = document.getElementById('message');

    messageInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            document.getElementById('send').click();
        }
    });
    document.getElementById('send').onclick = function() {
        const message = document.getElementById('message').value;
        const chat = document.getElementById('chat');
        // const message_container_outer = document.createElement('div');
        // const message_container_inner = document.createElement('div');
        // const new_message = document.createElement('p');
        // new_message.innerText = message;
        // new_message.id = 'patient_message';
        // new_message.className = "text-white";
        // message_container_outer.className = "flex justify-end"
        // message_container_inner.className = "rounded-2xl bg-[#63A3B0] p-2 mb-2 max-w-2xl";
        // message_container_inner.appendChild(new_message);
        // message_container_outer.appendChild(message_container_inner);
        // chat_bot.appendChild(message_container_outer);
        chat.innerHTML += `<div class="flex justify-end">
            <div class="rounded-2xl bg-[#63A3B0] p-2 mb-2 max-w-2xl inline-block">
                <p id='patient_message' class="text-white">${message}<p>
                </div></div>`;
        chat.scrollTop = chat.scrollHeight;
        scrollToBottom();
        socket.emit('user_message', message);
        document.getElementById('message').value = '';
    };

    var cur = 0;

    socket.on('bot_response', function(data) {
        const max = 6;
        const chat = document.getElementById('chat');
        const container = document.getElementById('container');
        cur ++;
        
        console.log(cur, max)

        if (cur == max && typeof data === 'object') {
            let content = formatJson(data);
            container.innerHTML += `
            <textarea id="summary" class="rounded-2xl text-black bg-white p-2 mb-2 inline-block" styles="width: 100%;">
                ${content}
            </textarea>`
            ;
            scrollToBottom();
            socket.emit('final_data', formatJson(data));
        } else {
            chat.innerHTML += `<div  id="assistant_message" class="rounded-2xl text-black bg-white p-2 mb-2 max-w-2xl inline-block">${data}</div><br><br>`;
            scrollToBottom();
        }
    });

    function formatJson(json) {
        let formattedText = ""

        formattedText += `Patient Details:\n`;
        formattedText += `Age: ${json.patient_details.age}\n`;
        formattedText += `Sex: ${json.patient_details.sex}\n`;

        formattedText += `Possible Next Steps:\n`;
        json.possible_next_steps.forEach((step, index) => {
            formattedText += `${index+1}. ${step}\n`;
        })
        formattedText += `\n`;

        formattedText += 'Summary:\n';
        json.summary.forEach((line, index) => {
            formattedText += `${index+1}. ${line}\n`;
        })

        return formattedText
    }

    // Function to scroll the chat container to the bottom
    function scrollToBottom() {
        const chatContainer = document.getElementById('chat');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
</script>

{% endblock %}

<script src="https://cdn.jsdelivr.net/md-editor/latest/mdEditor.min.js"></script>
